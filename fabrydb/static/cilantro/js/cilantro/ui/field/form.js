define(["underscore","backbone","marionette","loglevel","../../core","../base","../charts","../config","./info","./stats","./controls"],function(t,e,i,n,o,s,r,a,l,c,u){var h=s.LoadView.extend({message:"Loading fields..."}),d=i.Layout.extend({className:"field-form",getTemplate:function(){return this.options.condensed?"field/form-condensed":"field/form"},options:{info:!0,chart:!1,stats:!0,controls:!0,condensed:!1},ui:{apply:"[data-action=apply]",update:"[data-action=update]",state:"[data-target=state]"},events:{"click @ui.apply":"applyFilter","click @ui.update":"applyFilter"},filterEvents:{applied:"renderFilter",unapplied:"renderFilter",change:"renderFilter"},regions:{info:".info-region",stats:".stats-region",chart:".chart-region",controls:".controls-region"},regionViews:{info:l.FieldInfo,stats:c.FieldStats,chart:r.FieldChart,controls:u.FieldControls},initialize:function(t){if(this.data={},!(this.data.concept=t.concept))throw new Error("concept required");if(!(this.data.context=t.context))throw new Error("context required");t.filter||(t.filter=this.data.context.define({concept:this.data.concept.id,field:this.model.id})),this.data.filter=t.filter,i.bindEntityEvents(this,this.data.filter,i.getOption(this,"filterEvents"))},onRender:function(){this.$el.attr("id",this.data.filter.id),this.options.condensed&&this.$el.addClass("condensed"),this.options.info&&this.renderInfo(),this.options.stats&&this.model.stats&&this.renderStats(),this.options.controls&&this.renderControls(),this.options.chart&&this.model.links.distribution&&this.renderChart(),this.renderFilter()},renderInfo:function(){var e={model:this.model};t.isObject(this.options.info)&&t.extend(e,this.options.info),this.info.show(new this.regionViews.info(e))},renderStats:function(){var e={model:this.model,collection:this.model.stats};t.isObject(this.options.stats)&&t.extend(e,this.options.stats),this.stats.show(new this.regionViews.stats(e))},renderControls:function(){var i=[];if(t.each(this.options.controls,function(e){var n={model:this.model,filter:this.data.filter};t.isObject(e)?t.extend(n,e):n.control=e,i.push(n)},this),i.length>0){var n=new this.regionViews.controls({collection:new e.Collection(i)});this.controls.show(n)}},renderChart:function(){var e;e=this.options.condensed?{chart:{height:100}}:{chart:{height:200}},e.context=this.context,e.model=this.model,t.isObject(this.options.chart)&&t.extend(e,this.options.chart),this.chart.show(new this.regionViews.chart(e))},renderFilter:function(){if(this.ui.apply.prop("disabled",!1),this.ui.update.prop("disabled",!0),this.ui.state.hide(),this.data.context.isFilterApplied(this.data.filter)){this.ui.apply.hide(),this.ui.update.show();var e=[];this.controls.currentView.children.each(function(i){i.view&&(e=e.concat(t.keys(i.view.get())))}),this.data.context.hasFilterChanged(this.data.filter,e)&&this.ui.update.prop("disabled",!1)}else this.ui.apply.show(),this.ui.update.hide()},validateFilter:function(){var t,e=[],i=this.data.filter.toJSON();return this.controls.currentView.children.each(function(n){n.view&&(t=n.view.validate(i),t&&e.push(t))}),e.length?(this.validationErrors=e,this.ui.state.html(e.join("<br>")).show(),!1):(this.validationErrors=null,this.ui.state.text("").hide(),!0)},applyFilter:function(t){t.preventDefault(),this.validateFilter()&&this.data.filter.apply()}}),p=s.ErrorView.extend({}),f=i.View.extend({itemView:d,emptyView:h,errorView:p,collectionEvents:{reset:"render"},initialize:function(){if(this.data={},!(this.data.concept=this.options.concept))throw new Error("concept required");if(!(this.data.context=this.options.context))throw new Error("context required")},render:function(){if(this.collection.length){var t=this;this.collection.each(function(e,i){t.renderItem(e,i)})}return this},renderItem:function(e,i){var o=t.extend({},this.options,{model:e,context:this.data.context,concept:this.data.concept,index:i});this.collection.length<2?o.info=!1:i>0&&this.options.condense&&(o.condensed=!0);var s=a.resolveFormOptions(e,"fields");if(t.extend(o,s.options),s.module){var r=this;require([s.module],function(t){r.createView(t,o)},function(t){r.showErrorView(e),n.debug(t)})}else this.createView(s.view||this.itemView,o)},createView:function(t,e){try{var i=new t(e);i.render(),o.dom.insertAt(this.$el,e.index,i.el)}catch(n){if(this.showErrorView(e.model),o.config.get("debug"))throw n}},showErrorView:function(t){var e=new this.errorView({model:t});e.render(),this.$el.html(e.el)}}),g=i.ItemView.extend({tagName:"li",template:"field/link",ui:{anchor:"a"},serializeData:function(){return{name:this.model.get("alt_name")||this.model.get("name")}}}),m=i.CompositeView.extend({template:"field/links",itemView:g,itemViewContainer:"[data-target=links]",onAfterItemAdded:function(t){var e=this.options.concept,i="c"+e.id+"f"+t.model.id;t.ui.anchor.attr("href","#"+i)}});return{FieldForm:d,FieldFormCollection:f,FieldLinkCollection:m}});
//@ sourceMappingURL=form.js.map